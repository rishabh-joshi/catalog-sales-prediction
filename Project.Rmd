---
title: "MSIA 401 Project"
author: "Jill Fan, Will Song, Lauren Gardner, Rush Joshi"
date: "11/3/2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message = F, warning = F}
library(lubridate)
```

```{r}
data <- read.csv("catalog sales data.csv", stringsAsFactors = F)

data$target <- as.numeric(data$targdol > 0)
data$datead6 <- as.Date(data$datead6, format = '%m/%d/%Y')
data$datelp6 <- as.Date(data$datelp6, format = '%m/%d/%Y')

train <- data[data$train == 1,]
test <- data[data$train == 0,]

```


# Inconsistency in order history -- editted by Will
## adding fall/spring categorical
```{r}
data$lpurmonth <- month(data$datelp6)
data$season <- 'spring'
data[data$lpurmonth>6,]$season <- 'fall'
```

## updating order history
```{r}
difford <- data$falord + data$sprord - data$ordhist
data[difford >0,]$ordhist <- data[difford > 0,]$falord + data[difford > 0,]$sprord

# Check the last order date, if fall, update fall, else update string
#data[difford < 0,]$falord <- data[difford > 0,]$ordhist - data[difford > 0,]$sprord

for (i in 1:nrow(data)) {
  if (difford[i] <0 && data$season[i] =='spring') {
    data$sprord[i] <- data$ordhist[i]-data$falord[i]
  }
  else if  (difford[i] <0 && data$season[i] =='fall') {
    data$falord[i] <- data$ordhist[i]-data$sprord[i]
  }
}

# check whether all fields are updated now
all(data$falor+data$sprord==data$ordhist)  # true

```


# Manage inconsistency in datelp6 and lpuryear -- editted by Will
1. if lpuryear is NA ==> update it with the year parsed from 'datelp6'. The new variable is called 'datelp6_year'

2. if lpuryear is not NA ==>
  a. first convert them back to normal 4-digit years for our convenience
  b. compare it with 'datelp6_year', and update one of them with the larger one
  
```{r}
nna_lpuryear <- data[!is.na(data$lpuryear),]
table(nna_lpuryear$datelp6_year)
# the above table shows that all non-NA lpuryears are in between 2003-2012

data$datelp6_year <- year(data$datelp6)
# first change back to 4-digit years for those non-NA years
data[!is.na(data$lpuryear),]$lpuryear <- ifelse(data[!is.na(data$lpuryear),]$lpuryear<3,as.integer(paste0('201',as.character(data[!is.na(data$lpuryear),]$lpuryear))),as.integer(paste0('200',as.character(data[!is.na(data$lpuryear),]$lpuryear))))
# then fill in the NA years
data[is.na(data$lpuryear),]$lpuryear <- data[is.na(data$lpuryear),]$datelp6_year


# This loop runs very slowly but provides the result we want. Feel free to change it to make it faster!
for (i in 1:nrow(data)) {
  if (data$lpuryear[i] < data$datelp6_year[i]) data$lpuryear[i] <- data$datelp6_year[i]
  else data$datelp6_year[i] <- data$lpuryear[i]
}

```

# Select Date within [1985, 2012] for year added and [2003, 2012] for last purchase
```{r}
data <- data[(year(data$datead6)>=1985) & (year(data$datead6)<=2012),]
data <- data[(data$lpuryear>=2003) & (data$lpuryear<=2012),]
```


# TODO:
check last order date and update total order history, falord & sprord accordingly -- [done]

fall [Jul - Dec] spring [Jan - Jun] -- [done]

update 'lpuryear' and 'datelp6_year'(a newly created variable by parsing data from date of last purchase within 6 months) -- [done] 

range of year added [1985 - 2012]

range of last purchase [2003 - 2012]



# before fri
0. do correlations between x's
1. fit model ==> try to find outliers and effect of interactions
            ==> check VIF's






